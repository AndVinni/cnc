		    /* avtoyp.c  -индикация отработки управляющих программ */
		   //             в автоматическом режиме
// name_kpp.NC              - имя файла программы или подпрограммы
// INT fnomp               - индекс имени программы или подпрограммы в буфере
// CHAR name_kpp[fnomp][10] - имя программы или подпрограммы
// LONG fnstr               - номер строки программы,отрабатываемой в данный
//                            момент
// INT bnomp <= 20          - уровень вложенности программы или подпрограммы
 #include <stdlib.h>
 #include <stdio.h>
 #include <conio.h>
 #include <string.h>
 #include <dos.h>
 #include <ctype.h>
 #include <dir.h>
 #include "cncraz.h"
 #include "cnccdef.h"
 #include "cnchard.h"
 #include "cnccstat.h"
 #include "cnccsti.h"
 #include "cncint.h"
 #include "cncintb.h"
 #include "cncun1.h"
 #include "cncpar.h"
 #include "cncshow.h"
 #include "cncscr.h"
 #include "cncdir.h"
 void avtoyp(void)
 {
   INT i_yp,le,ii_a,i_i,l2[20];
   static INT yrov=0,pr_mal=0,i_f=0,p_open[20];
   static INT isdvig=0,jsdvig=0;
   static CHAR *stran,name1_kpp[20][10];
   static INT ilen[20][16],ii_pr[7],jj_pr[7];
   CHAR f_yp[30];
   static LONG yk_fi[20];
   static LONG i_aktn=0;
   static INT i_akto,i_pred[20],a=0,list=0,perv=0;
   CHAR str[MAXSTR];
   static FILE *fiyp[20];
   if(sscp Ifset IPRA)
   {
   if(pr_mal==0)
   {
     stran=(char*) malloc(12800);
     pr_mal=1;
   }
   if(!Flag.DrawEnded)
   {
     if(ykz_byf[ik]->bnomp==0 || yrov!=ykz_byf[ik]->bnomp || perv==0) 
     {
       if((ykz_byf[ik]->bnomp!=0 && perv==0) || ykz_byf[ik]->bnomp!=0 || perv!=0)
       {

	 i_pred[i_f]=fnstr1[i_f]-1;
	 ii_pr[0]=0;
	 jj_pr[0]=0;
	 yk_fi[i_f]=ftell(fiyp[i_f]);
	   if(yrov>ykz_byf[ik]->bnomp)
	   {
	     while(i_f>ykz_byf[ik]->bnomp)
	     {
	       if(i_f<6)
	       {
		 isdvig--;jsdvig-=2;i_f--;
	       }
	       else
	       {
		 i_f--;
	       }
	     }
	   fseek(fiyp[i_f],yk_fi[i_f],1);
	   }
	   else
	   {
	     while(i_f<ykz_byf[ik]->bnomp)
	     {
	     if(i_f<6)
	     {
	     isdvig++;jsdvig+=2;i_f++;i_akto=0;
	     if(perv==0)
	     {
		ii_pr[i_f]=isdvig;
		jj_pr[i_f]=jsdvig;
	     }
	     }
	     else
	     {
	       i_f++;i_akto=0;
	     }
	   }
	   }
	 }
	 yrov=ykz_byf[ik]->bnomp;
	 if(perv!=0)
	 {
	 ii_pr[i_f]=isdvig;
	 jj_pr[i_f]=jsdvig;
	 }
     }
       for(i_yp=0;i_yp<i_f;i_yp++)
       {
	 if(i_yp==0)
	 {
	   l2[i_yp]=strlen(name2_kpp);
	 }
	 else
	 {
	   l2[i_yp]=strlen(name2_kpp+le2[i_yp-1]);
	 }
	   BordColor();
	   gotoxy(MINSZX+2+ii_pr[i_yp],MINSZY+3+jj_pr[i_yp]);
	   putch('\xda');
	   BordColor();
	   Line(MINSZX+3+ii_pr[i_yp],MINSZY+3+jj_pr[i_yp],MINSZX+3+ii_pr[i_yp],MINSZY+3+jj_pr[i_yp]);
	   Line(MINSZX+2+ii_pr[i_yp],MINSZY+4+jj_pr[i_yp],MINSZX+2+ii_pr[i_yp],MINSZY+19);
	   Line(MINSZX+4+l2[i_yp]+ii_pr[i_yp],MINSZY+3+jj_pr[i_yp],MINSZX+79,MINSZY+3+jj_pr[i_yp]);
	   gotoxy(MINSZX+4+ii_pr[i_yp],MINSZY+3+jj_pr[i_yp]);
	 Color(FBLUE,FYELLOW);
	 if(i_yp==0)
	 {
	   cputs(name2_kpp);
	 }
	 else
	 {
	   cputs((name2_kpp+le2[i_yp-1]));
	 }
	 for(i_i=0;i_i<(76-ii_pr[i_yp]);i_i++)
	 {
	   gotoxy(MINSZX+4+ii_pr[i_yp]+i_i,MINSZY+4+jj_pr[i_yp]);
	   NormColor();                            
	   putch(' ');
	 }
	 if( perv==0)
	 {
	 if(i_yp==0)
	 {
	 fnmerge(f_yp,"",Config[ED_CNC],name2_kpp,".nc");
	 }
	 else
	 {
	 fnmerge(f_yp,"",Config[ED_CNC],name2_kpp+le2[i_yp-1],".nc");
	 }
	 p_open[i_yp]=1;
	 if((fiyp[i_yp]=fopen(f_yp,"r"))==NULL)
	 {
	 gotoxy(MINSZX+3+ii_pr[i_yp],MINSZY+4+jj_pr[i_yp]);
	 cprintf(Mesage[40],f_yp);
	 }
	 else
	 {
	   for(i_i=0;i_i<=(15-jj_pr[i_i]);i_i++)
	   {
	     if(fgets(str,MAXSTR,fiyp[i_yp])!=NULL)
	     {
	     *(str+strlen(str)-1)='\0';
	     if(i_i==0)
	     {
	       ilen[i_yp][i_i]=0;
	     }
	       ilen[i_yp][i_i+1]=ilen[i_yp][i_i]+strlen(str)+1;
	       if(i_yp!=0)
		 ilen[i_yp][i_i+1]=ilen[i_yp][i_i]+(16-jj_pr[i_i])*80*i_yp+strlen(str)+1;
	     strcpy((stran+ilen[i_yp][i_i]),str);
	     }
	     else
	     {
	       fclose(fiyp[i_yp]);
	       p_open[i_yp]=0;
	     }
	   }
	 }
	 }
	   gotoxy(MINSZX+3+ii_pr[i_yp],MINSZY+4+jj_pr[i_yp]);
	   NormColor();
	   cputs((stran+ilen[i_yp][i_pred[i_yp]]));
       }
	 perv=1;
	 gotoxy(MINSZX+4+isdvig,MINSZY+3+jsdvig);
	 le=strlen(name_kpp[ykz_byf[ik]->fnomp]);
	 for(i_yp=0;i_yp<=9;i_yp++)
	 {
	   name1_kpp[ykz_byf[ik]->fnomp][i_yp]=toupper(name_kpp[ykz_byf[ik]->fnomp][i_yp]);
	 }
	 Color(FBLUE,FYELLOW);
	 cputs(name1_kpp[ykz_byf[ik]->fnomp]);
	 fnmerge(f_yp,"",Config[ED_CNC],name1_kpp[ykz_byf[ik]->fnomp],".nc");
	 if((fiyp[i_f]=fopen(f_yp,"r"))==NULL)
	 {
	 gotoxy(MINSZX+3+isdvig,MINSZY+4+jsdvig);
	 cprintf(Mesage[40],f_yp);
	 }
	 else
	 {
	   BordColor();
	   gotoxy(MINSZX+2+isdvig,MINSZY+3+jsdvig);
	   putch('\xda');
	   BordColor();
	   Line(MINSZX+3+isdvig,MINSZY+3+jsdvig,MINSZX+3+isdvig,MINSZY+3+jsdvig);
	   NormColor();
	   ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	   BordColor();
	   Line(MINSZX+2+isdvig,MINSZY+4+jsdvig,MINSZX+2+isdvig,MINSZY+19);
	   Line(MINSZX+4+le+isdvig,MINSZY+3+jsdvig,MINSZX+79,MINSZY+3+jsdvig);
	   for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	   {
	     if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)
	     {
	     *(str+strlen(str)-1)='\0';
	     if(i_yp==0)
	     {
	       ilen[i_f][i_yp]=0;
	     }
	       ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
	       if(i_f!=0)
		 ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+(16-jsdvig)*80*i_f+strlen(str)+1;
	     strcpy((stran+ilen[i_f][i_yp]),str);
	     gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
	     NormColor();
	     cputs(str);
	     }
	     else
	     {
	       fclose(fiyp[i_f]);
	       p_open[i_f]=0;
	     }
	   }
//         yrov=ykz_byf[ik]->bnomp;
//     }
//	   if(i_aktn!=ykz_byf[ik]->fnstr)
//	   {
	   if(i_aktn>ykz_byf[ik]->fnstr)
	   {
	     i_aktn=ykz_byf[ik]->fnstr;
	   if(p_open[i_f]==0)
	   {
	     fnmerge(f_yp,"",Config[ED_CNC],name1_kpp[ykz_byf[ik]->fnomp],".nc");
	     if((fiyp[i_f]=fopen(f_yp,"r"))==NULL)
	     {
	       gotoxy(MINSZX+3+isdvig,MINSZY+4+jsdvig);
	       cprintf(Mesage[40],f_yp);
	     }
	     else
	     {
	       p_open[i_f]=1;
	       i_akto=0;
	       if(list!=1)
	       {
	       for(i_yp=0;i_yp<list;i_yp++)
	       {
		 if(a!=0)
		 a--;
	       }	           
	       }
	       else
	       {
		 a--;
	       }
	       NormColor();
	       ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	       fseek(fiyp[i_f],0,0);
	       for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	       {
		 if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)        
		 {
		   *(str+strlen(str)-1)='\0';
		   if(i_yp==0)
		   {
		     ilen[i_f][i_yp]=0;
		   }
		   ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
		   if(i_f!=0)
		   ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
		   strcpy((stran+ilen[i_f][i_yp]),str);
		   gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
		   NormColor();
		   cputs(str);
		 }
		 else
		 {
		   fclose(fiyp[i_f]);
		   p_open[i_f]=0;
		 }
	       }
	     }
	   }
	   else
	   {
	     i_akto=0;
	     NormColor();
	     ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	     fseek(fiyp[i_f],0,0);
	     for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	     {
	       if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)        
	       {
		 *(str+strlen(str)-1)='\0';
		 if(i_yp==0)
		 {
		   ilen[i_f][i_yp]=0;
		 }
		 ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
		 if(i_f!=0)
		 ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
		 strcpy((stran+ilen[i_f][i_yp]),str);
		 gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
		 NormColor();
		 cputs(str);
	       }
	       else
	       {
		 fclose(fiyp[i_f]);
		 p_open[i_f]=0;
	       }
	     }
	   }
	 }
	 i_aktn=ykz_byf[ik]->fnstr;
       if(i_aktn>=(16-jsdvig)*(a+1))
       {
	 i_akto=0;
	 list++;
	 a++;
	 NormColor();
	 ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	 for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	 {
	   if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)
	   {
	     *(str+strlen(str)-1)='\0';
	     if(i_yp==0)
	     {
	       ilen[i_f][i_yp]=0;
	     }
	       ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
	       if(i_f!=0)
		  ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
	     strcpy((stran+ilen[i_f][i_yp]),str);
	     gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
	     NormColor();
	     cputs(str);
	   }
	     else
	     {
	       fclose(fiyp[i_f]);
	       p_open[i_f]=0;
	     }
	 }
       }
	     if(ykz_byf[ik]->fnstr>=(16-jsdvig)*a)
	       ii_a=(int)ykz_byf[ik]->fnstr-(16-jsdvig)*a;
	     else
	       ii_a=(int)ykz_byf[ik]->fnstr;
	     if(i_aktn!=0 || i_aktn!=1)
	     {
	       NormColor();
	       gotoxy(MINSZX+3+isdvig,MINSZY+4+i_akto+jsdvig);
	       cputs((stran+ilen[i_f][i_akto]));
	     }
	       LightColor();
	       gotoxy(MINSZX+3+isdvig,MINSZY+4+ii_a+jsdvig);
	       cputs((stran+ilen[i_f][ii_a]));
	       i_akto=ii_a;
//	   }
	 }
   }
   else
   {
       if(yrov!=ykz_byf[ik]->bnomp)
       {
	 for(i_yp=0;i_yp<(76-isdvig);i_yp++)
	 {
	   gotoxy(MINSZX+4+isdvig+i_yp,MINSZY+4+jsdvig);
	   NormColor();
	   putch(' ');
	 }
	 gotoxy(MINSZX+3+isdvig,MINSZY+4+jsdvig);
	 NormColor();
	 cputs((stran+ilen[i_f][i_akto-1]));
	 i_pred[i_f]=fnstr1[i_f]-1;
	 yk_fi[i_f]=ftell(fiyp[i_f]);
	 if(yrov>ykz_byf[ik]->bnomp)
	 {        
	     while(i_f>ykz_byf[ik]->bnomp)
	     {
	       if(i_f<6)
	       {
		 isdvig--;jsdvig-=2;i_f--;
	       }
	       else
	       {
		 i_f--;
	       }
	     }
	   fseek(fiyp[i_f],yk_fi[i_f],1);
	 }
	 else
	 {
	   if(ykz_byf[ik]->bnomp<=6)
	   {
	     isdvig++;jsdvig+=2;i_f++;i_akto=0;
	   }
	   else
	   {
	     i_f++;i_akto=0;
	   }
	 }   
	 gotoxy(MINSZX+4+isdvig,MINSZY+3+jsdvig);
	 le=strlen(name_kpp[ykz_byf[ik]->fnomp]);
	 Color(FBLUE,FYELLOW);
	 for(i_yp=0;i_yp<=9;i_yp++)
	 {
	   name1_kpp[ykz_byf[ik]->fnomp][i_yp]=toupper(name_kpp[ykz_byf[ik]->fnomp][i_yp]);
	 }
	 cputs(name1_kpp[ykz_byf[ik]->fnomp]);
	 fnmerge(f_yp,"",Config[ED_CNC],name1_kpp[ykz_byf[ik]->fnomp],".nc");
	 if((fiyp[i_f]=fopen(f_yp,"r"))==NULL)
	 {
	 gotoxy(MINSZX+3+isdvig,MINSZY+4+jsdvig);
	 cprintf(Mesage[40],f_yp);
	 }
	 else
	 {
	   p_open[i_f]=1;
	   BordColor();
	   gotoxy(MINSZX+2+isdvig,MINSZY+3+jsdvig);
	   putch('\xda');
	   BordColor();
	   Line(MINSZX+3+isdvig,MINSZY+3+jsdvig,MINSZX+3+isdvig,MINSZY+3+jsdvig);
	   NormColor();
	   ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	   BordColor();
	   Line(MINSZX+2+isdvig,MINSZY+4+jsdvig,MINSZX+2+isdvig,MINSZY+19);
	   Line(MINSZX+4+le+isdvig,MINSZY+3+jsdvig,MINSZX+79,MINSZY+3+jsdvig);
	   for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	   {
	     if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)
	     {
	     *(str+strlen(str)-1)='\0';
	     if(i_yp==0)
	     {
	       ilen[i_f][i_yp]=0;
	     }
	       ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
	       if(i_f!=0)
		  ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
	     strcpy((stran+ilen[i_f][i_yp]),str);
	     gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
	     NormColor();
	     cputs(str);
	     }
	     else
	     {
	       fclose(fiyp[i_f]);
	       p_open[i_f]=0;
	     }
	   }
	 }
	 yrov=ykz_byf[ik]->bnomp;
	 ii_pr[i_f]=isdvig;
	 jj_pr[i_f]=jsdvig;
       }
       if(i_aktn!=ykz_byf[ik]->fnstr)
       {
	 if(i_aktn>ykz_byf[ik]->fnstr)
	 {
	   i_aktn=ykz_byf[ik]->fnstr;
	   if(p_open[i_f]==0)
	   {
	     fnmerge(f_yp,"",Config[ED_CNC],name1_kpp[ykz_byf[ik]->fnomp],".nc");
	     if((fiyp[i_f]=fopen(f_yp,"r"))==NULL)
	     {
	       gotoxy(MINSZX+3+isdvig,MINSZY+4+jsdvig);
	       cprintf(Mesage[40],f_yp);
	     }
	     else
	     {
	       p_open[i_f]=1;
	       i_akto=0;
	       if(list!=1)
	       {
	       for(i_yp=0;i_yp<list;i_yp++)
	       {
		 if(a!=0)
		 a--;
	       }	           
	       }
	       else
	       {
		 a--;
	       }
	       NormColor();
	       ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	       fseek(fiyp[i_f],0,0);
	       for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	       {
		 if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)        
		 {
		   *(str+strlen(str)-1)='\0';
		   if(i_yp==0)
		   {
		     ilen[i_f][i_yp]=0;
		   }
		   ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
		   if(i_f!=0)
		   ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
		   strcpy((stran+ilen[i_f][i_yp]),str);
		   gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
		   NormColor();
		   cputs(str);
		 }
		 else
		 {
		   fclose(fiyp[i_f]);
		   p_open[i_f]=0;
		 }
	       }
	     }
	   }
	   else
	   {
	     i_akto=0;                                                                     
	     NormColor();
	     ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	     fseek(fiyp[i_f],0,0);
	     for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	     {
	       if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)        
	       {
		 *(str+strlen(str)-1)='\0';
		 if(i_yp==0)
		 {
		   ilen[i_f][i_yp]=0;
		 }
		 ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
		 if(i_f!=0)
		 ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
		 strcpy((stran+ilen[i_f][i_yp]),str);
		 gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
		 NormColor();
		 cputs(str);
	       }
	       else
	       {
		 fclose(fiyp[i_f]);
		 p_open[i_f]=0;
	       }
	     }
	   }
	 }
	 i_aktn=ykz_byf[ik]->fnstr;
       if(i_aktn>=(16-jsdvig)*(a+1))
       {
	 i_akto=0;
	 list++;
	 a++;
	 NormColor();
	 ClrWind(MINSZX+3+isdvig,MINSZY+4+jsdvig,80,20);
	 for(i_yp=0;i_yp<=(15-jsdvig);i_yp++)
	 {
	   if(fgets(str,MAXSTR,fiyp[i_f])!=NULL)
	   {
	     *(str+strlen(str)-1)='\0';
	     if(i_yp==0)
	     {
	       ilen[i_f][i_yp]=0;
	     }
	       ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+strlen(str)+1;
	       if(i_f!=0)
		  ilen[i_f][i_yp+1]=ilen[i_f][i_yp]+1280*i_f+strlen(str)+1;
	     strcpy((stran+ilen[i_f][i_yp]),str);
	     gotoxy(MINSZX+3+isdvig,MINSZY+4+i_yp+jsdvig);
	     NormColor();
	     cputs(str);
	   }
	   else
	   {
	     fclose(fiyp[i_f]);
	     p_open[i_f]=0;
	   }
	 }
       }
	 if(ykz_byf[ik]->fnstr>=(16-jsdvig)*a)
	 {
	   ii_a=(int)ykz_byf[ik]->fnstr-(16-jsdvig)*a;
	 }
	 else
	   ii_a=(int)ykz_byf[ik]->fnstr;
	 if(i_aktn!=0 || i_aktn!=1)
	 {  
	   NormColor();
	   gotoxy(MINSZX+3+isdvig,MINSZY+4+i_akto+jsdvig);
	   cputs((stran+ilen[i_f][i_akto]));
	 }
	 LightColor();
	 gotoxy(MINSZX+3+isdvig,MINSZY+4+ii_a+jsdvig);
	 cputs((stran+ilen[i_f][ii_a]));
	 i_akto=ii_a;
       }
   }
 }
 }
